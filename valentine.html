<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChÃºc Má»«ng Valentine</title>
    <!-- Favicon - Valentine Heart -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='90' text-anchor='middle' x='50'>ğŸ’–</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css?v=6.0">
    
    <!-- Firebase SDK (v8 compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>

</head>
<body class="birthday-wish">
    <div class="wish-container" id="wishContainer">
        <h1 class="main-title">ğŸ’– Happy Valentine's Day! ğŸ’–</h1>
        
        <div class="book-container">
            <!-- BÃºt lÃ´ng vÅ© trang trÃ­ -->
            <div class="feather-pen">
                <div class="feather">
                    <div class="feather-shaft"></div>
                    <div class="feather-barbs">
                        <div class="barb"></div>
                        <div class="barb"></div>
                        <div class="barb"></div>
                        <div class="barb"></div>
                        <div class="barb"></div>
                    </div>
                </div>
                <div class="pen-nib"></div>
                <div class="ink-drop">ğŸ’§</div>
            </div>
            <div class="book" id="book">
                <div class="book-cover" onclick="openBook()">
                    <img src="images/anhbia.jpg?v=20260211" alt="Valentine Photo" class="cover-image" loading="lazy" decoding="async">
                </div>
                
                <!-- Trang 1: Lá»i chÃºc chÃ­nh -->
                <div class="book-page page-1" id="page1" onclick="event.stopPropagation()">
                    <div class="wish-content">
                        <div class="page-header">
                            <span class="page-number">1</span>
                            <button class="edit-btn" onclick="toggleEdit(1)">âœï¸ Chá»‰nh sá»­a</button>
                            <button class="copy-link-btn" onclick="copyPageLink(1)">ğŸ“ Copy link</button>
                        </div>
                        <div class="message editable-content" id="content1" contenteditable="false">
                            <p class="message-line">HÃ´m nay lÃ  ngÃ y cá»§a yÃªu thÆ°Æ¡ng,</p>
                            <p class="message-line">NgÃ y Ä‘á»ƒ mÃ¬nh nÃ³i lá»i trÃ¢n trá»ng nháº¥t.</p>
                            <p class="message-line">Cáº£m Æ¡n em vÃ¬ luÃ´n dá»‹u dÃ ng vÃ  áº¥m Ã¡p,</p>
                            <p class="message-line">Cáº£m Æ¡n em vÃ¬ Ä‘Ã£ á»Ÿ bÃªn cáº¡nh anh.</p>
                            <p class="message-line">ChÃºc mÃ¬nh mÃ£i ngá»t ngÃ o nhÆ° hÃ´m nay! ğŸ’•</p>
                            <p class="message-line">VÃ  má»i Ä‘iá»u Æ°á»›c sáº½ thÃ nh hiá»‡n thá»±c! ğŸ’˜</p>
                        </div>
                        <div class="edit-controls" id="controls1" style="display: none;">
                            <button onclick="saveContent(1)" class="save-btn">ğŸ’¾ LÆ°u</button>
                            <button onclick="cancelEdit(1)" class="cancel-btn">âŒ Há»§y</button>
                        </div>
                        <div class="page-nav">
                            <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                        </div>
                    </div>
                </div>
                
                <!-- Trang 2: Ká»· niá»‡m -->
                <div class="book-page page-2" id="page2" style="display: none;" onclick="event.stopPropagation()">
                    <div class="wish-content">
                        <div class="page-header">
                            <span class="page-number">2</span>
                            <button class="edit-btn" onclick="toggleEdit(2)">âœï¸ Chá»‰nh sá»­a</button>
                            <button class="copy-link-btn" onclick="copyPageLink(2)">ğŸ“ Copy link</button>
                        </div>
                        <div class="page-title">ğŸ“¸ Nhá»¯ng Ká»· Niá»‡m ÄÃ¡ng YÃªu</div>
                        <div class="message editable-content" id="content2" contenteditable="false">
                            <p class="message-line">Nhá»› nhá»¯ng láº§n mÃ¬nh náº¯m tay tháº­t cháº·t,</p>
                            <p class="message-line">Nhá»¯ng cÃ¢u chuyá»‡n nhá» nhÆ°ng Ä‘áº§y áº¥m Ã¡p,</p>
                            <p class="message-line">Nhá»¯ng chuyáº¿n Ä‘i, nhá»¯ng khoáº£nh kháº¯c,</p>
                            <p class="message-line">Táº¥t cáº£ Ä‘á»u tháº­t Ä‘Ã¡ng yÃªu! ğŸŒŸ</p>
                            <p class="message-line">Cáº£m Æ¡n em Ä‘Ã£ bÆ°á»›c vÃ o</p>
                            <p class="message-line">cuá»™c Ä‘á»i nÃ y! ğŸ’–</p>
                        </div>
                        <div class="edit-controls" id="controls2" style="display: none;">
                            <button onclick="saveContent(2)" class="save-btn">ğŸ’¾ LÆ°u</button>
                            <button onclick="cancelEdit(2)" class="cancel-btn">âŒ Há»§y</button>
                        </div>
                        <div class="page-nav">
                            <button onclick="prevPage()" class="nav-btn">â† Trang trÆ°á»›c</button>
                            <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                        </div>
                    </div>
                </div>
                
                <!-- Trang 3: Lá»i chÃºc tÆ°Æ¡ng lai -->
                <div class="book-page page-3" id="page3" style="display: none;" onclick="event.stopPropagation()">
                    <div class="wish-content">
                        <div class="page-header">
                            <span class="page-number">3</span>
                            <button class="edit-btn" onclick="toggleEdit(3)">âœï¸ Chá»‰nh sá»­a</button>
                            <button class="copy-link-btn" onclick="copyPageLink(3)">ğŸ“ Copy link</button>
                        </div>
                        <div class="page-title">ğŸŒˆ Lá»i Æ¯á»›c Cho ChÃºng MÃ¬nh</div>
                        <div class="message editable-content" id="content3" contenteditable="false">
                            <p class="message-line">Mong em luÃ´n khá»e máº¡nh vÃ  háº¡nh phÃºc,</p>
                            <p class="message-line">Má»—i ngÃ y Ä‘á»u trÃ n Ä‘áº§y tiáº¿ng cÆ°á»i,</p>
                            <p class="message-line">Má»i Ä‘iá»u em muá»‘n Ä‘á»u thuáº­n lá»£i,</p>
                            <p class="message-line">TÃ¬nh yÃªu luÃ´n áº¥m Ã¡p, bÃ¬nh yÃªn! ğŸ </p>
                            <p class="message-line">VÃ  hÃ£y nhá»› ráº±ng cÃ³ anh</p>
                            <p class="message-line">luÃ´n á»§ng há»™ em! ğŸ’ª</p>
                        </div>
                        <div class="edit-controls" id="controls3" style="display: none;">
                            <button onclick="saveContent(3)" class="save-btn">ğŸ’¾ LÆ°u</button>
                            <button onclick="cancelEdit(3)" class="cancel-btn">âŒ Há»§y</button>
                        </div>
                        <div class="page-nav">
                            <button onclick="prevPage()" class="nav-btn">â† Trang trÆ°á»›c</button>
                            <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                        </div>
                    </div>
                </div>
                
                <!-- Trang 4: Lá»i káº¿t -->
                <div class="book-page page-4" id="page4" style="display: none;" onclick="event.stopPropagation()">
                    <div class="wish-content">
                        <div class="page-header">
                            <span class="page-number">4</span>
                            <button class="edit-btn" onclick="toggleEdit(4)">âœï¸ Chá»‰nh sá»­a</button>
                            <button class="copy-link-btn" onclick="copyPageLink(4)">ğŸ“ Copy link</button>
                        </div>
                        <div class="page-title">ğŸ’– Valentine Ngá»t NgÃ o ğŸ’–</div>
                        <div class="message special-message editable-content" id="content4" contenteditable="false">
                            <p class="message-line big-text">YÃªu em nhiá»u!</p>
                            <p class="message-line">ğŸ’˜ğŸŒ¹ğŸ’âœ¨</p>
                            <p class="message-line">ChÃºc em má»™t Valentine</p>
                            <p class="message-line">tháº­t áº¥m Ã¡p vÃ  háº¡nh phÃºc.</p>
                            <p class="message-line">VÃ  chÃºng mÃ¬nh sáº½</p>
                            <p class="message-line">luÃ´n bÃªn nhau! âœ¨</p>
                        </div>
                        <div class="signature editable-content" id="signature4" contenteditable="false">
                            ğŸ’ Love you 3000 ğŸ’
                        </div>
                        <div class="edit-controls" id="controls4" style="display: none;">
                            <button onclick="saveContent(4)" class="save-btn">ğŸ’¾ LÆ°u</button>
                            <button onclick="cancelEdit(4)" class="cancel-btn">âŒ Há»§y</button>
                        </div>
                        <div class="page-nav">
                            <button onclick="prevPage()" class="nav-btn">â† Trang trÆ°á»›c</button>
                            <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="click-hint" id="clickHint">ğŸ‘† Nháº¥p vÃ o sá»• Ä‘á»ƒ má»Ÿ nhÃ©!!!</div>

        <!-- Top navigation bar with online counter and controls -->
        <div class="top-nav-bar">
            <!-- Online counter -->
            <div class="online-counter" id="onlineCounter">
                <span class="online-dot"></span>
                <span id="onlineCount">0</span> ngÆ°á»i Ä‘ang xem
            </div>
            
            <!-- NÃºt Ä‘iá»u khiá»ƒn nháº¡c, lá»‹ch vÃ  khoáº£nh kháº¯c -->
            <div class="controls-bar">
                <div class="music-control control-btn" id="musicControl" onclick="toggleMusic()" title="Báº­t/Táº¯t nháº¡c">
                    ğŸµ
                </div>
                
                <div class="camera-control control-btn" id="cameraControl" onclick="openGallery()" title="Xem khoáº£nh kháº¯c">
                    ğŸ“¸
                </div>
                
                <div class="calendar-control control-btn" id="calendarControl" onclick="toggleDaysInfo()" title="Xem ngÃ y bÃªn nhau">
                    ğŸ“…
                </div>
                
                <div class="quotes-control control-btn" id="quotesControl" onclick="toggleQuotes()" title="Xem lá»i yÃªu thÆ°Æ¡ng">
                    ğŸ’¬
                </div>
            </div>
        </div>
        
        <!-- Love Bot Chat Bubbles Container -->
        <div class="lovebot-container" id="lovebotContainer" onclick="expandWhenMinimized(event)">
            <div class="lovebot-header">
                <img src="images/avatar.jpg" alt="Love Bot" class="lovebot-avatar">
                <div class="lovebot-header-title">Anh YÃªu</div>
                <div style="display: flex; gap: 4px;">
                    <button class="lovebot-clear-all" onclick="event.stopPropagation(); clearAllMessages()" title="XÃ³a táº¥t cáº£ tin nháº¯n">ğŸ—‘ï¸</button>
                    <button class="lovebot-minimize" onclick="event.stopPropagation(); toggleLoveBot()" title="Minimize">_</button>
                    <button class="lovebot-close" onclick="event.stopPropagation(); minimizeLoveBot()">âœ–</button>
                </div>
            </div>
            
            <div class="lovebot-messages">
                <div class="chat-bubble-item bot-msg">
                    <div class="chat-bubble bot-message">
                        <div class="chat-message-text">Hellu Bae! Nhá»› anh rá»“i háº£aaa</div>
                    </div>
                </div>
            </div>
            
            <div class="lovebot-footer">
                <input type="text" class="lovebot-input" placeholder="Viáº¿t tin nháº¯n..." id="lovebotInput">
                <button class="lovebot-send-btn" id="lovebotSendBtn" onclick="sendUserMessage()">Gá»­i</button>
            </div>
        </div>
        
        <!-- Modal hiá»ƒn thá»‹ love quotes -->
        <div class="quotes-modal" id="quotesModal" onclick="closeQuotes(event)">
            <div class="quotes-content" onclick="event.stopPropagation()">
                <button class="close-modal-btn" onclick="closeQuotes()">âœ–</button>
                
                <div class="modal-header">
                    <h2>ğŸ’• Lá»i YÃªu ThÆ°Æ¡ng ğŸ’•</h2>
                </div>
                
                <div class="modal-body">
                    <div class="quote-display">
                        <div class="quote-text" id="quoteText">ğŸ’• YÃªu em nhiá»u! ğŸ’•</div>
                        <div class="quote-author" id="quoteAuthor" style="display: none;">- Tá»« trÃ¡i tim anh</div>
                    </div>
                    
                    <div class="quote-counter">
                        <span id="quoteCurrentIndex">1</span> / <span id="quoteTotalCount">0</span>
                    </div>
                    
                    <div class="quote-navigation">
                        <button onclick="prevQuote()" class="quote-nav-btn">â† TrÆ°á»›c</button>
                        <button onclick="randomQuote()" class="quote-nav-btn random-btn">ğŸ² Ngáº«u nhiÃªn</button>
                        <button onclick="nextQuote()" class="quote-nav-btn">Sau â†’</button>
                    </div>
                    
                    <button class="copy-quote-btn" onclick="copyQuote()" title="Copy lá»i yÃªu thÆ°Æ¡ng">
                        ğŸ“‹ Copy lá»i yÃªu thÆ°Æ¡ng
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal hiá»ƒn thá»‹ ngÃ y bÃªn nhau -->
        <div class="days-info-modal" id="daysInfoModal" onclick="closeDaysInfo(event)">
            <div class="days-info-content" onclick="event.stopPropagation()">
                <button class="close-modal-btn" onclick="closeDaysInfo()">âœ–</button>
                
                <div class="modal-header">
                    <h2>ğŸ’• NgÃ y BÃªn Nhau ğŸ’•</h2>
                </div>
                
                <div class="modal-body">
                    <div class="big-days-display">
                        <div class="days-item">
                            <div class="days-item-label">NgÃ y</div>
                            <div class="days-item-number" id="modalDaysNumber">0</div>
                        </div>
                        <div class="separator">|</div>
                        <div class="days-item">
                            <div class="days-item-label">Tuáº§n</div>
                            <div class="days-item-number" id="modalWeekNumber">0</div>
                        </div>
                        <div class="separator">|</div>
                        <div class="days-item">
                            <div class="days-item-label">ThÃ¡ng</div>
                            <div class="days-item-number" id="modalMonthNumber">0</div>
                        </div>
                        <div class="separator">|</div>
                        <div class="days-item">
                            <div class="days-item-label">NÄƒm</div>
                            <div class="days-item-number" id="modalYearNumber">0</div>
                        </div>
                    </div>
                    
                    <div class="modal-start-date" id="modalStartDate"></div>
                    
                    <div class="modal-message">
                        Tá»« ngÃ y Ä‘áº§u tiÃªn gáº·p nhau Ä‘áº¿n giá» ğŸ’–
                    </div>
                    
                    <div class="edit-date-form-modal" id="editDateFormModal" style="display: none;">
                        <div class="form-group">
                            <label for="startDateModal">Chá»n ngÃ y báº¯t Ä‘áº§u:</label>
                            <input type="date" id="startDateModal" class="date-input">
                            <div class="form-buttons">
                                <button onclick="saveDaysDate()" class="save-btn">ğŸ’¾ LÆ°u</button>
                                <button onclick="toggleEditDate()" class="cancel-btn">âŒ Há»§y</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="edit-date-quick-btn" id="editDateToggleBtn" onclick="toggleEditDate()">
                        âœï¸ Chá»‰nh sá»­a ngÃ y báº¯t Ä‘áº§u
                    </button>
                </div>
            </div>
        </div>
        
        <div class="button-container">
            <a href="index.html" class="back-button">Quay láº¡i</a>
        </div>
    </div>

    <canvas class="confetti" id="confetti"></canvas>
    <div class="hearts-container" id="heartsContainer"></div>
    
    <!-- Photo Gallery Modal -->
    <div class="gallery-modal" id="galleryModal">
        <div class="gallery-content">
            <div class="gallery-header">
                <h2>ğŸ“¸ Khoáº£nh Kháº¯c ÄÃ¡ng Nhá»› ğŸ’–</h2>
                <button class="close-gallery" onclick="closeGallery()">âœ–</button>
            </div>
            
            <div class="upload-section">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">Click hoáº·c kÃ©o áº£nh vÃ o Ä‘Ã¢y</div>
                    <div class="upload-hint">(JPG, PNG, tá»‘i Ä‘a 5MB)</div>
                </div>
                <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
            </div>
            
            <div class="gallery-grid" id="galleryGrid">
                <div class="loading-photos">Äang táº£i áº£nh...</div>
            </div>
        </div>
    </div>
    
    <!-- ThÃªm audio element -->
    <audio id="birthdayMusic" preload="auto">
        <source src="audio/valentine.mp3" type="audio/mpeg">
        <source src="audio/birthday-music.wav" type="audio/wav">
        <!-- Fallback cho cÃ¡c trÃ¬nh duyá»‡t khÃ´ng há»— trá»£ -->
        Your browser does not support the audio element.
    </audio>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAp7dDBS7i48tNlPKQJSJEptnKzE-xaqiI",
            authDomain: "valentine-fd73c.firebaseapp.com",
            databaseURL: "https://valentine-fd73c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "valentine-fd73c",
            storageBucket: "valentine-fd73c.firebasestorage.app",
            messagingSenderId: "260681999001",
            appId: "1:260681999001:web:65c5b862824b9df35b4e08"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const pagesRef = database.ref('valentinePages');
        const photosRef = database.ref('photos');
        
        // Cloudinary Cloud Name
        const CLOUDINARY_CLOUD_NAME = 'dn3vjvokz';

        // Monitor Firebase connection status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                // Firebase connected
            } else {
                // Connecting to Firebase...
            }
        });

        // Online presence tracking
        const presenceRef = database.ref('presence');
        const myConnectionRef = presenceRef.push();
        
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                // ThÃªm user vÃ o danh sÃ¡ch online
                myConnectionRef.set({
                    online: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Tá»± Ä‘á»™ng xÃ³a khi disconnect
                myConnectionRef.onDisconnect().remove();
            }
        });
        
        // Äáº¿m sá»‘ ngÆ°á»i online
        presenceRef.on('value', (snapshot) => {
            const onlineCount = snapshot.numChildren();
            const countElement = document.getElementById('onlineCount');
            if (countElement) {
                countElement.textContent = onlineCount;
            }
        });

        // Functions for page navigation
        let currentPage = 1;
        let totalPages = 4;
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const isMobile = window.innerWidth <= 768;
        const confettiCount = prefersReducedMotion ? 0 : (isMobile ? 80 : 150);
        const heartIntervalMs = isMobile ? 1200 : 800;
        const heartDurationMs = isMobile ? 12000 : 20000;
        
        // Love Quotes Data - Danh sÃ¡ch lá»i yÃªu thÆ°Æ¡ng ngáº«u nhiÃªn
        const loveQuotes = [
            "YÃªu em lÃ  cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ báº¯t Ä‘áº§u má»—i ngÃ y.",
            "Em lÃ  lÃ­ do tÃ´i tin vÃ o tÃ¬nh yÃªu.",
            "Má»—i khoáº£nh kháº¯c bÃªn em Ä‘á»u cÃ³ giÃ¡ trá»‹ vÃ´ cÃ¹ng.",
            "Em lÃ  nÆ¡i tÃ´i muá»‘n á»Ÿ Ä‘áº¿n cuá»‘i cÃ¹ng.",
            "TÃ´i yÃªu em nhiá»u hÆ¡n cÃ¡ch tÃ´i yÃªu chÃ­nh mÃ¬nh.",
            "NÆ¡i em á»Ÿ, nÆ¡i Ä‘Ã³ lÃ  quÃª hÆ°Æ¡ng cá»§a tÃ´i.",
            "Ná»¥ cÆ°á»i cá»§a em lÃ  Ã¡nh náº¯ng cá»§a cuá»™c sá»‘ng tÃ´i.",
            "Anh muá»‘n dÃ nh cáº£ Ä‘á»i Ä‘á»ƒ khiáº¿n em háº¡nh phÃºc.",
            "Em lÃ  thiÃªn tháº§n mÃ  tÃ´i khÃ´ng xá»©ng Ä‘Ã¡ng nhÆ°ng biáº¿t Æ¡n vÃ¬ cÃ³ Ä‘Æ°á»£c.",
            "TÃ¬nh yÃªu cá»§a anh dÃ nh cho em tidak cÃ³ giá»›i háº¡n.",
            "Em lÃ  lÃ½ do tÃ´i tin vÃ o Ä‘iá»u khÃ´ng thá»ƒ.",
            "Má»™t ngÃ y khÃ´ng tháº¥y em lÃ  má»™t ngÃ y thiáº¿u váº¯ng.",
            "YÃªu em lÃ  quyáº¿t Ä‘á»‹nh dá»… dÃ ng nháº¥t cá»§a tÃ´i.",
            "Em lÃ m cho má»i thá»© cÃ³ Ã½ nghÄ©a, ngay cáº£ nhá»¯ng Ä‘iá»u bÃ¬nh thÆ°á»ng.",
            "TrÃ¡i tim tÃ´i chá»‰ biáº¿t nhá»‹p Ä‘áº­p khi em á»Ÿ bÃªn.",
            "Em lÃ  bÃ i hÃ¡t yÃªu thÃ­ch mÃ  tÃ´i muá»‘n nghe mÃ£i mÃ£i.",
            "TÃ´i khÃ´ng cáº§n cáº£ tháº¿ giá»›i, náº¿u tÃ´i cÃ³ em.",
            "Cáº£m Æ¡n em vÃ¬ luÃ´n á»Ÿ Ä‘Ã³ khi anh cáº§n.",
            "Em lÃ  hy vá»ng, em lÃ  mÆ¡ má»™ng, em lÃ  tÆ°Æ¡ng lai cá»§a tÃ´i.",
            "YÃªu em lÃ  viá»‡c tá»‘t nháº¥t tÃ´i tá»«ng lÃ m.",
            "Em lÃ  ngÆ°á»i mÃ  anh muá»‘n Ä‘á»ƒ buá»•i sÃ¡ng Ä‘áº§u tiÃªn vÃ  buá»•i tá»‘i cuá»‘i cÃ¹ng.",
            "TÃ¬nh yÃªu cá»§a anh lÃ  vÄ©nh viá»…n, khÃ´ng bao giá» thay Ä‘á»•i.",
            "Má»—i láº§n nhÃ¬n em, anh Ä‘á»u yÃªu em hÆ¡n.",
            "Em lÃ  chá»©ng minh ráº±ng nhá»¯ng Ä‘iá»u tá»‘t nháº¥t lÃ  khÃ´ng thá»ƒ lÃªn káº¿ hoáº¡ch.",
            "Vá»›i em, anh tÃ¬m tháº¥y ráº¥t nhiá»u lÃ½ do Ä‘á»ƒ cÆ°á»i.",
            "Em lÃ  con tim cá»§a anh bÃªn ngoÃ i cÆ¡ thá»ƒ.",
            "BÃ¬nh yÃªn lÃ  khi anh náº±m cáº¡nh em.",
            "Em lÃ m cho ngÃ y tá»‡ nháº¥t cá»§a anh trá»Ÿ thÃ nh tá»‘t.",
            "Anh yÃªu: ná»¥ cÆ°á»i cá»§a em, tiáº¿ng cÆ°á»i cá»§a em, cÃ¡ch em nhÃ¬n anh.",
            "Em lÃ  Ä‘iá»u duy nháº¥t anh cáº§n Ä‘á»ƒ háº¡nh phÃºc."
        ];
        
        let currentQuoteIndex = 0;
        let loveBotUserMessages = [];
        
        function showPage(pageNum) {
            // áº¨n táº¥t cáº£ cÃ¡c trang
            for (let i = 1; i <= totalPages; i++) {
                const page = document.getElementById(`page${i}`);
                if (page) {
                    page.style.display = 'none';
                }
            }
            
            // Hiá»ƒn thá»‹ trang hiá»‡n táº¡i
            const currentPageElement = document.getElementById(`page${pageNum}`);
            if (currentPageElement) {
                currentPageElement.style.display = 'flex';
            }
            
            currentPage = pageNum;
        }
        
        function nextPage() {
            if (currentPage >= totalPages) {
                // Táº¡o trang má»›i
                createNewPage();
            }
            if (currentPage < totalPages) {
                // PhÃ¡t Ã¢m thanh láº­t trang (tÃ¹y chá»n)
                playPageFlipSound();
                showPageWithAnimation(currentPage + 1);
            }
        }
        
        function prevPage() {
            if (currentPage > 1) {
                // PhÃ¡t Ã¢m thanh láº­t trang (tÃ¹y chá»n)
                playPageFlipSound();
                showPageWithAnimation(currentPage - 1);
            }
        }
        
        function showPageWithAnimation(pageNum) {
            const currentPageElement = document.getElementById(`page${currentPage}`);
            const nextPageElement = document.getElementById(`page${pageNum}`);
            
            if (pageNum === currentPage) return;
            
            // Hiá»‡u á»©ng láº­t trang nhanh vÃ  mÆ°á»£t
            if (currentPageElement) {
                currentPageElement.classList.add('flipping-out');
                
                setTimeout(() => {
                    currentPageElement.style.display = 'none';
                    currentPageElement.classList.remove('flipping-out');
                }, 600);
            }
            
            // Hiá»ƒn thá»‹ trang má»›i
            if (nextPageElement) {
                setTimeout(() => {
                    nextPageElement.style.display = 'flex';
                    nextPageElement.classList.add('flipping-in');
                    
                    // Shimmer effect Ä‘Æ¡n giáº£n
                    nextPageElement.classList.add('page-shimmer');
                    setTimeout(() => {
                        nextPageElement.classList.add('active');
                    }, 50);
                    
                    // Cleanup
                    setTimeout(() => {
                        nextPageElement.classList.remove('flipping-in', 'page-shimmer', 'active');
                    }, 600);
                }, 300);
            }
            
            currentPage = pageNum;
        }
        
        // Simple page flip sound - optimized for performance
        function playPageFlipSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Simple swoosh sound
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Audio not available
            }
        }

        // Interactive editing functions
        let originalContent = {};
        
        function toggleEdit(pageNum) {
            const content = document.getElementById(`content${pageNum}`);
            const controls = document.getElementById(`controls${pageNum}`);
            const editBtn = document.querySelector(`#page${pageNum} .edit-btn`);
            
            if (content.contentEditable === 'false') {
                // Báº¯t Ä‘áº§u chá»‰nh sá»­a
                originalContent[pageNum] = content.innerHTML;
                content.contentEditable = 'true';
                content.classList.add('editing');
                content.focus();
                controls.style.display = 'flex';
                editBtn.style.display = 'none';
                
                // Add typing sound effect
                content.addEventListener('input', playTypingSound);
            }
        }
        
        function saveContent(pageNum) {
            const content = document.getElementById(`content${pageNum}`);
            const controls = document.getElementById(`controls${pageNum}`);
            const editBtn = document.querySelector(`#page${pageNum} .edit-btn`);
            
            const dataToSave = {
                content: content.innerHTML,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // LÆ°u vÃ o Firebase Realtime Database
            pagesRef.child(`page${pageNum}`).set(dataToSave).then(() => {
                
                // Káº¿t thÃºc chá»‰nh sá»­a
                content.contentEditable = 'false';
                content.classList.remove('editing');
                controls.style.display = 'none';
                editBtn.style.display = 'inline-block';
                
                // Remove typing sound listener
                content.removeEventListener('input', playTypingSound);
                
                // Show save notification
                showNotification('ğŸ’¾ ÄÃ£ lÆ°u vÃ o cloud thÃ nh cÃ´ng!');
            }).catch((error) => {
                showNotification('âŒ Lá»—i khi lÆ°u: ' + error.message);
            });
        }
        
        function cancelEdit(pageNum) {
            const content = document.getElementById(`content${pageNum}`);
            const controls = document.getElementById(`controls${pageNum}`);
            const editBtn = document.querySelector(`#page${pageNum} .edit-btn`);
            
            // KhÃ´i phá»¥c ná»™i dung gá»‘c
            content.innerHTML = originalContent[pageNum];
            content.contentEditable = 'false';
            content.classList.remove('editing');
            controls.style.display = 'none';
            editBtn.style.display = 'inline-block';
            
            // Remove typing sound listener
            content.removeEventListener('input', playTypingSound);
        }
        
        function playTypingSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(800 + Math.random() * 200, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.02, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // Silent fail
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }
        
        // Load saved content from Firebase - Realtime sync
        function loadSavedContent() {
            // Sá»­ dá»¥ng .on() Ä‘á»ƒ tá»± Ä‘á»™ng cáº­p nháº­t khi cÃ³ thay Ä‘á»•i
            pagesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Láº¥y táº¥t cáº£ cÃ¡c page tá»« Firebase
                    Object.keys(data).forEach(key => {
                        const match = key.match(/page(\d+)/);
                        if (match) {
                            const pageNum = parseInt(match[1]);
                            const pageData = data[key];
                            
                            // Táº¡o trang náº¿u chÆ°a tá»“n táº¡i
                            let pageElement = document.getElementById(`page${pageNum}`);
                            if (!pageElement && pageNum > 4) {
                                createPageWithNumber(pageNum);
                                pageElement = document.getElementById(`page${pageNum}`);
                            }
                            
                            // Load ná»™i dung
                            if (pageData && pageData.content) {
                                const content = document.getElementById(`content${pageNum}`);
                                if (content && content.contentEditable === 'false') {
                                    // Chá»‰ update khi khÃ´ng Ä‘ang chá»‰nh sá»­a
                                    content.innerHTML = pageData.content;
                                }
                            }
                            
                            // Cáº­p nháº­t totalPages
                            if (pageNum > totalPages) {
                                totalPages = pageNum;
                            }
                        }
                    });
                } else {
                    // No data in Firebase yet
                }
            }, (error) => {
                // Firebase load error
            });
        }
        
        // Helper function Ä‘á»ƒ táº¡o trang vá»›i sá»‘ cá»¥ thá»ƒ
        function createPageWithNumber(pageNum) {
            const bookContainer = document.querySelector('.book');
            const existingPage = document.getElementById(`page${pageNum}`);
            if (existingPage) return; // ÄÃ£ tá»“n táº¡i
            
            const newPage = document.createElement('div');
            newPage.className = 'book-page page-' + pageNum;
            newPage.id = 'page' + pageNum;
            newPage.style.display = 'none';
            newPage.onclick = (e) => e.stopPropagation();
            
            const deleteBtn = pageNum > 4 ? `<button class="delete-btn" onclick="deletePage(${pageNum})">ğŸ—‘ï¸ XÃ³a</button>` : '';
            
            newPage.innerHTML = `
                <div class="wish-content">
                    <div class="page-header">
                        <span class="page-number">${pageNum}</span>
                        <button class="edit-btn" onclick="toggleEdit(${pageNum})">âœï¸ Chá»‰nh sá»­a</button>
                        <button class="copy-link-btn" onclick="copyPageLink(${pageNum})">ğŸ“ Copy link</button>
                        ${deleteBtn}
                    </div>
                    <div class="message editable-content" id="content${pageNum}" contenteditable="false">
                        <p class="message-line">Äang táº£i...</p>
                    </div>
                    <div class="edit-controls" id="controls${pageNum}" style="display: none;">
                        <button onclick="saveContent(${pageNum})" class="save-btn">ğŸ’¾ LÆ°u</button>
                        <button onclick="cancelEdit(${pageNum})" class="cancel-btn">âŒ Há»§y</button>
                    </div>
                    <div class="page-nav">
                        <button onclick="prevPage()" class="nav-btn">â† Trang trÆ°á»›c</button>
                        <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                    </div>
                </div>
            `;
            
            bookContainer.appendChild(newPage);
        }
        
        function resetBook() {
            currentPage = 1;
            showPage(currentPage);
        }
        
        // Copy link to specific page
        function copyPageLink(pageNum) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageNum);
            
            navigator.clipboard.writeText(url.toString()).then(() => {
                showNotification(`ğŸ“ ÄÃ£ copy link trang ${pageNum}!`);
            }).catch(err => {
                showNotification('âŒ KhÃ´ng thá»ƒ copy link');
            });
        }
        
        // Delete page (only for page > 4)
        function deletePage(pageNum) {
            if (pageNum <= 4) {
                showNotification('âŒ KhÃ´ng thá»ƒ xÃ³a 4 trang Ä‘áº§u!');
                return;
            }
            
            if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a trang ${pageNum}?`)) {
                return;
            }
            
            // XÃ³a khá»i Firebase
            pagesRef.child(`page${pageNum}`).remove().then(() => {
                // XÃ³a khá»i DOM
                const pageElement = document.getElementById(`page${pageNum}`);
                if (pageElement) {
                    pageElement.remove();
                }
                
                // Chuyá»ƒn vá» trang trÆ°á»›c náº¿u Ä‘ang á»Ÿ trang bá»‹ xÃ³a
                if (currentPage === pageNum) {
                    currentPage = Math.max(1, pageNum - 1);
                    showPage(currentPage);
                }
                
                showNotification(`ğŸ—‘ï¸ ÄÃ£ xÃ³a trang ${pageNum}!`);
            }).catch(error => {
                showNotification('âŒ Lá»—i khi xÃ³a trang');
            });
        }

        function createNewPage() {
            totalPages++;
            const pageNum = totalPages;
            const bookContainer = document.querySelector('.book');
            
            const newPage = document.createElement('div');
            newPage.className = 'book-page page-' + pageNum;
            newPage.id = 'page' + pageNum;
            newPage.style.display = 'none';
            newPage.onclick = (e) => e.stopPropagation();
            
            const deleteBtn = pageNum > 4 ? `<button class="delete-btn" onclick="deletePage(${pageNum})">ğŸ—‘ï¸ XÃ³a</button>` : '';
            
            newPage.innerHTML = `
                <div class="wish-content">
                    <div class="page-header">
                        <span class="page-number">${pageNum}</span>
                        <button class="edit-btn" onclick="toggleEdit(${pageNum})">âœï¸ Chá»‰nh sá»­a</button>
                        <button class="copy-link-btn" onclick="copyPageLink(${pageNum})">ğŸ“ Copy link</button>
                        ${deleteBtn}
                    </div>
                    <div class="message editable-content" id="content${pageNum}" contenteditable="false">
                        <p class="message-line">Trang ${pageNum}</p>
                        <p class="message-line">TÃ´i yÃªu em vÃ  mÃ£i yÃªu em! â¤ï¸</p>
                    </div>
                    <div class="edit-controls" id="controls${pageNum}" style="display: none;">
                        <button onclick="saveContent(${pageNum})" class="save-btn">ğŸ’¾ LÆ°u</button>
                        <button onclick="cancelEdit(${pageNum})" class="cancel-btn">âŒ Há»§y</button>
                    </div>
                    <div class="page-nav">
                        <button onclick="prevPage()" class="nav-btn">â† Trang trÆ°á»›c</button>
                        <button onclick="nextPage()" class="nav-btn">Trang tiáº¿p theo â†’</button>
                    </div>
                </div>
            `;
            
            bookContainer.appendChild(newPage);
        }

        function createConfetti() {
            if (confettiCount <= 0) return;
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const confettiPieces = [];
            const colors = ['#ff9a9e', '#fecfef', '#fda085', '#ffb3ba', '#ff6b9d', '#ffc1cc'];

            for (let i = 0; i < confettiCount; i++) {
                confettiPieces.push({
                    x: Math.random() * canvas.width,
                    y: -10,
                    width: Math.random() * 10 + 5,
                    height: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    rotation: Math.random() * 360
                });
            }

            function animateConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                confettiPieces.forEach((piece, index) => {
                    piece.y += piece.speed;
                    piece.rotation += 2;

                    ctx.save();
                    ctx.translate(piece.x + piece.width / 2, piece.y + piece.height / 2);
                    ctx.rotate(piece.rotation * Math.PI / 180);
                    ctx.fillStyle = piece.color;
                    ctx.fillRect(-piece.width / 2, -piece.height / 2, piece.width, piece.height);
                    ctx.restore();

                    if (piece.y > canvas.height) {
                        confettiPieces.splice(index, 1);
                    }
                });

                if (confettiPieces.length > 0) {
                    requestAnimationFrame(animateConfetti);
                }
            }

            animateConfetti();
        }

        function createHearts() {
            if (prefersReducedMotion) return;
            const heartsContainer = document.getElementById('heartsContainer');
            
            function addHeart() {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = 'ğŸ’–';
                
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 3 + 5) + 's';
                heart.style.animationDelay = Math.random() * 2 + 's';
                
                heartsContainer.appendChild(heart);
                
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 8000);
            }
            
            const heartInterval = setInterval(addHeart, heartIntervalMs);
            
            setTimeout(() => {
                clearInterval(heartInterval);
            }, heartDurationMs);
        }

        // Báº¯t Ä‘áº§u hiá»‡u á»©ng khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            createConfetti();
            createHearts();
            // Load ná»™i dung Ä‘Ã£ lÆ°u tá»« Firebase
            loadSavedContent();
            
            // Check URL parameter Ä‘á»ƒ má»Ÿ trang cá»¥ thá»ƒ
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('page');
            if (pageParam) {
                const pageNum = parseInt(pageParam);
                if (pageNum > 0) {
                    // Äá»£i má»™t chÃºt Ä‘á»ƒ Firebase load xong
                    setTimeout(() => {
                        currentPage = pageNum;
                        openBook();
                        showPage(pageNum);
                    }, 1000);
                }
            }
            
            // Click ngoÃ i sá»• Ä‘á»ƒ Ä‘Ã³ng
            const wishContainer = document.getElementById('wishContainer');
            wishContainer.addEventListener('click', function(e) {
                const book = document.getElementById('book');
                const bookContainer = document.querySelector('.book-container');
                const controlsBar = document.querySelector('.controls-bar');
                const daysInfoModal = document.getElementById('daysInfoModal');
                const onlineCounter = document.getElementById('onlineCounter');
                const clickHint = document.getElementById('clickHint');
                
                // KhÃ´ng Ä‘Ã³ng sá»• náº¿u click vÃ o controls, modal, online counter, hoáº·c hint
                if (controlsBar && controlsBar.contains(e.target)) return;
                if (daysInfoModal && daysInfoModal.contains(e.target)) return;
                if (onlineCounter && onlineCounter.contains(e.target)) return;
                if (clickHint && clickHint.contains(e.target)) return;
                
                if (book.classList.contains('open') && !bookContainer.contains(e.target) && e.target !== bookContainer) {
                    closeBook();
                }
            });
            
            // Tá»± Ä‘á»™ng phÃ¡t nháº¡c khi user tÆ°Æ¡ng tÃ¡c (cho mobile)
            const music = document.getElementById('birthdayMusic');
            const musicControl = document.getElementById('musicControl');
            let musicStarted = false;
            
            function startMusicOnInteraction() {
                if (!musicStarted && music.paused) {
                    music.volume = 0.5;
                    music.play().then(() => {
                        musicControl.textContent = 'ğŸµ';
                        musicStarted = true;
                    }).catch(e => {/* Music play failed */});
                }
            }
            
            // Láº¯ng nghe má»i loáº¡i tÆ°Æ¡ng tÃ¡c Ä‘á»ƒ báº­t nháº¡c
            document.addEventListener('click', startMusicOnInteraction, { once: true });
            document.addEventListener('touchstart', startMusicOnInteraction, { once: true });
            document.addEventListener('touchend', startMusicOnInteraction, { once: true });
            
            // Initialize Love Bot
            initLoveBot();
        });

        function openBook() {
            const book = document.getElementById('book');
            const clickHint = document.getElementById('clickHint');
            const music = document.getElementById('birthdayMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (!book.classList.contains('open')) {
                // Má»Ÿ sÃ¡ch
                book.classList.add('open');
                clickHint.textContent = 'ğŸ‘† Nháº¥p ngoÃ i sá»• Ä‘á»ƒ Ä‘Ã³ng';
                clickHint.style.opacity = '0.7';
                
                // Hiá»ƒn thá»‹ trang Ä‘áº§u tiÃªn
                currentPage = 1;
                showPage(currentPage);
                
                // Hiá»ƒn thá»‹ bÃºt lÃ´ng vÅ© vá»›i delay Ä‘á»ƒ Ä‘á»“ng bá»™ vá»›i chá»¯
                setTimeout(() => {
                    const featherPen = document.querySelector('.feather-pen');
                    if (featherPen) {
                        featherPen.classList.add('show');
                    }
                }, 800);
                
                // PhÃ¡t nháº¡c khi má»Ÿ sá»•
                music.currentTime = 0;
                music.volume = 0.5;
                music.play().then(() => {
                    musicControl.textContent = 'ğŸµ';
                }).catch(error => {
                    // Music play failed
                });
            }
        }
        
        function closeBook() {
            const book = document.getElementById('book');
            const clickHint = document.getElementById('clickHint');
            const music = document.getElementById('birthdayMusic');
            const musicControl = document.getElementById('musicControl');
            
            book.classList.remove('open');
            clickHint.textContent = 'ğŸ‘† Nháº¥p vÃ o sá»• Ä‘á»ƒ má»Ÿ nhÃ©!!!';
            clickHint.style.opacity = '1';
            
            // áº¨n bÃºt lÃ´ng vÅ©
            const featherPen = document.querySelector('.feather-pen');
            if (featherPen) {
                featherPen.classList.remove('show');
            }
            
            // Dá»«ng nháº¡c khi Ä‘Ã³ng sá»•
            music.pause();
            music.currentTime = 0;
            musicControl.textContent = 'ğŸ”‡';
            
            // Reset vá» trang Ä‘áº§u
            currentPage = 1;
            showPage(currentPage);
        }

        function toggleMusic() {
            const music = document.getElementById('birthdayMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (music.paused) {
                music.play().then(() => {
                    musicControl.textContent = 'ğŸµ';
                }).catch(error => {
                    // Music play failed
                });
            } else {
                music.pause();
                musicControl.textContent = 'ğŸ”‡';
            }
        }

        // ==================== TOAST NOTIFICATION SYSTEM ====================
        function showToast(message, type = 'info', duration = 4000) {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <button class="toast-close" onclick="removeToast(this.parentElement)">&times;</button>
                <div>${message}</div>
                <div class="toast-progress"></div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);

            const progress = toast.querySelector('.toast-progress');
            progress.style.width = '100%';
            setTimeout(() => {
                progress.style.width = '0%';
                progress.style.transition = `width ${duration}ms linear`;
            }, 200);

            setTimeout(() => removeToast(toast), duration);
            return toast;
        }

        function removeToast(toast) {
            if (toast && toast.classList) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 400);
            }
        }

        function showSuccess(message, duration = 3000) {
            return showToast(message, 'success', duration);
        }
        function showWarning(message, duration = 4000) {
            return showToast(message, 'warning', duration);
        }
        function showError(message, duration = 4000) {
            return showToast(message, 'error', duration);
        }
        function showInfo(message, duration = 4000) {
            return showToast(message, 'info', duration);
        }
        
        // ==================== PHOTO GALLERY FUNCTIONS ====================
        const BLUR_PLACEHOLDER = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'><rect width='10' height='10' fill='%23f5f5f5'/></svg>";

        function loadLazyImage(img) {
            const src = img.getAttribute('data-src');
            if (!src) return;

            img.addEventListener('load', () => {
                img.classList.add('loaded');
                img.classList.remove('loading');
            }, { once: true });

            img.src = src;
            img.removeAttribute('data-src');
        }

        function setupLazyImages() {
            const images = document.querySelectorAll('img.lazy-image');
            if (!images.length) return;

            if (!('IntersectionObserver' in window)) {
                images.forEach(loadLazyImage);
                return;
            }

            if (!window.__lazyImageObserver) {
                window.__lazyImageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            loadLazyImage(entry.target);
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    root: document.getElementById('galleryModal'),
                    rootMargin: '150px',
                    threshold: 0.01
                });
            }

            images.forEach((img) => window.__lazyImageObserver.observe(img));
        }

        function openGallery() {
            const modal = document.getElementById('galleryModal');
            modal.style.display = 'flex';
            loadPhotos();
        }
        
        function closeGallery() {
            const modal = document.getElementById('galleryModal');
            modal.style.display = 'none';
        }
        
        // Drag and drop support
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ff9a9e';
                uploadArea.style.background = 'rgba(255, 154, 158, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = 'white';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = 'white';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadPhoto(files[0]);
                }
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadPhoto(file);
            }
        }
        
        function uploadPhoto(file) {
            // Validate file
            if (!file.type.startsWith('image/')) {
                showError('âŒ Chá»‰ cháº¥p nháº­n file áº£nh!');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB
                showError('âŒ áº¢nh quÃ¡ lá»›n! Tá»‘i Ä‘a 5MB');
                return;
            }
            
            showInfo('ğŸ’¾ Äang upload áº£nh...');
            
            // Upload to Cloudinary
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'valentine_photos'); // Cáº§n táº¡o upload preset
            
            fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError('âŒ Lá»—i upload: ' + data.error.message);
                    return;
                }
                
                // Save metadata to Firebase Database
                photosRef.push({
                    url: data.secure_url,
                    public_id: data.public_id,
                    filename: file.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    showSuccess('âœ¨ ÄÃ£ thÃªm áº£nh thÃ nh cÃ´ng!');
                    loadPhotos();
                    document.getElementById('photoInput').value = '';
                }).catch((error) => {
                    showError('âŒ Lá»—i khi lÆ°u metadata');
                });
            })
            .catch(error => {
                showError('âŒ Lá»—i khi upload: ' + error.message);
            });
        }
        
        function loadPhotos() {
            const gridElement = document.getElementById('galleryGrid');
            gridElement.innerHTML = '<div class="loading-photos">Äang táº£i áº£nh...</div>';
            
            photosRef.orderByChild('timestamp').once('value').then((snapshot) => {
                gridElement.innerHTML = '';
                
                if (!snapshot.exists()) {
                    gridElement.innerHTML = '<div class="no-photos">ğŸ“¸ ChÆ°a cÃ³ áº£nh nÃ o. HÃ£y thÃªm khoáº£nh kháº¯c Ä‘áº§u tiÃªn!</div>';
                    return;
                }
                
                const photos = [];
                snapshot.forEach((child) => {
                    photos.push({ key: child.key, ...child.val() });
                });
                
                // Display photos (newest first)
                photos.reverse().forEach((photo) => {
                    const photoCard = document.createElement('div');
                    photoCard.className = 'photo-card';
                    photoCard.innerHTML = `
                        <img class="lazy-image loading" src="${BLUR_PLACEHOLDER}" data-src="${photo.url}" alt="${photo.filename}" loading="lazy" decoding="async" onclick="viewPhoto('${photo.url}', '${photo.filename}')">
                        <div class="photo-actions">
                            <button onclick="deletePhoto('${photo.key}', '${photo.path}')" class="delete-photo-btn">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    gridElement.appendChild(photoCard);
                });

                setupLazyImages();
            }).catch((error) => {
                gridElement.innerHTML = '<div class="no-photos">âŒ Lá»—i khi táº£i áº£nh</div>';
            });
        }
        
        function viewPhoto(url, filename) {
            window.open(url, '_blank');
        }
        
        function deletePhoto(key, publicId) {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a áº£nh nÃ y?')) {
                return;
            }
            
            photosRef.child(key).remove().then(() => {
                showSuccess('ğŸ—‘ï¸ ÄÃ£ xÃ³a áº£nh!');
                loadPhotos();
            }).catch((error) => {
                showError('âŒ Lá»—i khi xÃ³a áº£nh');
            });
        }

        // ==================== DAYS TOGETHER COUNTER ====================
        const DAYS_COUNTER_KEY = 'valentineDaysStartDate';
        
        function calculateDaysBetween(startDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            
            const diffTime = Math.abs(today - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }
        
        function updateDaysCounter() {
            const startDateStr = localStorage.getItem(DAYS_COUNTER_KEY);
            
            if (!startDateStr) {
                // Náº¿u chÆ°a cÃ³ ngÃ y, hiá»ƒn thá»‹ form Ä‘á»ƒ ngÆ°á»i dÃ¹ng nháº­p
                const daysNumber = document.getElementById('daysNumber');
                const counterDetails = document.querySelector('.counter-details');
                const startDateDisplay = document.getElementById('startDateDisplay');
                
                if (daysNumber) daysNumber.textContent = '?';
                if (counterDetails) counterDetails.style.display = 'none';
                if (startDateDisplay) startDateDisplay.textContent = 'ğŸ‘† Nháº¥n âœï¸ Ä‘á»ƒ thiáº¿t láº­p ngÃ y báº¯t Ä‘áº§u';
                return;
            }
            
            const days = calculateDaysBetween(startDateStr);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30.44); // Trung bÃ¬nh má»™t thÃ¡ng
            const years = Math.floor(days / 365.25); // Trung bÃ¬nh má»™t nÄƒm
            
            const daysNumber = document.getElementById('daysNumber');
            const weekValue = document.getElementById('weekValue');
            const monthValue = document.getElementById('monthValue');
            const yearValue = document.getElementById('yearValue');
            const startDateDisplay = document.getElementById('startDateDisplay');
            
            if (daysNumber) daysNumber.textContent = days;
            if (weekValue) weekValue.textContent = weeks;
            if (monthValue) monthValue.textContent = months;
            if (yearValue) yearValue.textContent = years;
            
            if (startDateDisplay) {
                const displayDate = new Date(startDateStr).toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                startDateDisplay.textContent = `Tá»« ngÃ y ${displayDate}`;
            }
            
            // Update modal info
            const modalDaysNumber = document.getElementById('modalDaysNumber');
            const modalWeekNumber = document.getElementById('modalWeekNumber');
            const modalMonthNumber = document.getElementById('modalMonthNumber');
            const modalYearNumber = document.getElementById('modalYearNumber');
            const modalStartDate = document.getElementById('modalStartDate');
            
            if (modalDaysNumber) modalDaysNumber.textContent = days;
            if (modalWeekNumber) modalWeekNumber.textContent = weeks;
            if (modalMonthNumber) modalMonthNumber.textContent = months;
            if (modalYearNumber) modalYearNumber.textContent = years;
            
            if (modalStartDate) {
                const displayDate = new Date(startDateStr).toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                modalStartDate.textContent = `Tá»« ngÃ y ${displayDate}`;
            }
        }
        
        function toggleEditDate() {
            const editForm = document.getElementById('editDateFormModal');
            const startDateInput = document.getElementById('startDateModal');
            const toggleBtn = document.getElementById('editDateToggleBtn');
            
            if (!editForm || !startDateInput) {
                return;
            }
            
            if (editForm.style.display === 'none') {
                editForm.style.display = 'block';
                toggleBtn.style.display = 'none';
                
                // Set current value
                const startDateStr = localStorage.getItem(DAYS_COUNTER_KEY);
                if (startDateStr) {
                    // Format date to YYYY-MM-DD for input
                    const dateObj = new Date(startDateStr);
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    startDateInput.value = `${year}-${month}-${day}`;
                } else {
                    startDateInput.value = '';
                }
                
                startDateInput.focus();
            } else {
                editForm.style.display = 'none';
                toggleBtn.style.display = 'block';
            }
        }
        
        function saveDaysDate() {
            const startDateInput = document.getElementById('startDateModal');
            const selectedDate = startDateInput.value;
            
            if (!selectedDate) {
                showWarning('âš ï¸ Vui lÃ²ng chá»n ngÃ y!');
                return;
            }
            
            // Validate date
            const dateObj = new Date(selectedDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (dateObj > today) {
                showWarning('âš ï¸ NgÃ y khÃ´ng thá»ƒ lÃ  ngÃ y tÆ°Æ¡ng lai!');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem(DAYS_COUNTER_KEY, selectedDate);
            
            // Save to Firebase for real-time sync
            try {
                database.ref('shared/daysStartDate').set({
                    date: selectedDate,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                // Failed to save to Firebase
            }
            
            // Update display
            updateDaysCounter();
            
            // Hide form
            document.getElementById('editDateFormModal').style.display = 'none';
            document.getElementById('editDateToggleBtn').style.display = 'block';
            
            showSuccess('ğŸ’• ÄÃ£ lÆ°u ngÃ y báº¯t Ä‘áº§u! (Cáº£ hai ngÆ°á»i Ä‘á»u cÃ³ thá»ƒ tháº¥y)');
        }
        
        // Toggle days info modal
        function toggleDaysInfo() {
            const modal = document.getElementById('daysInfoModal');
            if (!modal) return;
            
            if (modal.classList.contains('show')) {
                closeDaysInfo();
            } else {
                updateDaysCounter(); // Ensure data is up-to-date
                modal.classList.add('show');
            }
        }
        
        // Close days info modal
        function closeDaysInfo(event) {
            const modal = document.getElementById('daysInfoModal');
            if (!modal) return;
            
            // Close if clicking on the modal backdrop (not the content)
            if (event && !event.target.closest('.days-info-content')) {
                modal.classList.remove('show');
            } else if (!event) {
                // Always close if called without an event (from close button)
                modal.classList.remove('show');
            }
        }
        
        // Initialize counter on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load days start date from Firebase and listen for real-time updates
            const sharedDaysRef = database.ref('shared/daysStartDate');
            
            sharedDaysRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.date) {
                    // Save to localStorage
                    localStorage.setItem(DAYS_COUNTER_KEY, data.date);
                    // Update display
                    updateDaysCounter();
                }
            });
            
            // Update counter on initial load
            updateDaysCounter();
            
            // Update counter every minute
            setInterval(updateDaysCounter, 60000);
            
            // Update quote count on load
            updateQuoteCount();
        });
        
        // ==================== LOVE QUOTES FUNCTIONS ====================
        function displayQuote(index) {
            if (loveQuotes.length === 0) return;
            
            index = (index + loveQuotes.length) % loveQuotes.length;
            currentQuoteIndex = index;
            
            const quoteText = document.getElementById('quoteText');
            const quoteCurrentIndex = document.getElementById('quoteCurrentIndex');
            
            if (quoteText) {
                quoteText.innerHTML = 'ğŸ’ ' + loveQuotes[index] + ' ğŸ’';
            }
            if (quoteCurrentIndex) {
                quoteCurrentIndex.textContent = index + 1;
            }
        }
        
        function updateQuoteCount() {
            const quoteTotalCount = document.getElementById('quoteTotalCount');
            if (quoteTotalCount) {
                quoteTotalCount.textContent = loveQuotes.length;
            }
        }
        
        function nextQuote() {
            displayQuote(currentQuoteIndex + 1);
        }
        
        function prevQuote() {
            displayQuote(currentQuoteIndex - 1);
        }
        
        function randomQuote() {
            const randomIndex = Math.floor(Math.random() * loveQuotes.length);
            displayQuote(randomIndex);
            showSuccess('ğŸ’ Má»™t lá»i yÃªu thÆ°Æ¡ng ngáº«u nhiÃªn cho em!');
        }
        
        function toggleQuotes() {
            const modal = document.getElementById('quotesModal');
            if (!modal) return;
            
            if (modal.classList.contains('show')) {
                closeQuotes();
            } else {
                modal.classList.add('show');
                displayQuote(currentQuoteIndex);
            }
        }
        
        function closeQuotes(event) {
            const modal = document.getElementById('quotesModal');
            if (!modal) return;
            
            // Close if clicking on the modal backdrop (not the content)
            if (event && !event.target.closest('.quotes-content')) {
                modal.classList.remove('show');
            } else if (!event) {
                // Always close if called without an event (from close button)
                modal.classList.remove('show');
            }
        }
        
        function copyQuote() {
            const quote = loveQuotes[currentQuoteIndex];
            const textToCopy = 'ğŸ’ ' + quote + ' ğŸ’';
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showSuccess('ğŸ’• ÄÃ£ copy lá»i yÃªu thÆ°Æ¡ng!');
            }).catch(err => {
                showError('âŒ KhÃ´ng thá»ƒ copy');
            });
        }
        
        // ==================== LOVE BOT FUNCTIONS ====================
        const LOVEBOT_API_URL = window.LOVEBOT_API_URL || 'https://valentine-website-f2u1.onrender.com/api/chat';
        
        // Love Bot optimization variables
        let loveBotAbortController = null;
        let loveBotLastRequestTime = 0;
        const LOVEBOT_REQUEST_COOLDOWN = 1000; // 1 second debounce
        const LOVEBOT_REQUEST_TIMEOUT = 10000; // 10 second timeout
        const LOVEBOT_MAX_RETRIES = 2;
        const LOVEBOT_RATE_LIMIT = 20; // Max 20 messages per minute
        let loveBotRequestCount = 0;
        let loveBotRateLimitResetTime = Date.now() + 60000;
        
        // Simple response cache (question -> answer)
        const loveBotCache = new Map();
        const LOVEBOT_CACHE_SIZE = 50;
        const LOVEBOT_CACHE_TTL = 300000; // 5 minutes
        
        const loveBotGreetings = [
            "Em Ä‘ang lÃ m gÃ¬ váº­y? ğŸ˜Š",
            "Báº¡n vui khÃ´ng? ğŸ’–",
            "Em cÃ³ khá»e khÃ´ng? ğŸ¥°",
            "Nhá»› em láº¯m! ğŸ’•",
            "ChÃºc em má»™t ngÃ y tá»‘t lÃ nh! â˜€ï¸",
            "Em Ä‘ang báº­n rá»“i Ã ? ğŸ¤”",
            "Anh/chá»‹ yÃªu em láº¯m láº¯m! ğŸ’˜",
            "Cáº£m Æ¡n em vÃ¬ luÃ´n á»Ÿ bÃªn cáº¡nh! ğŸŒ¹",
            "Em muá»‘n Äƒn gÃ¬ khÃ´ng? ğŸ°",
            "Anh/chá»‹ chá»‰ muá»‘n em háº¡nh phÃºc! âœ¨",
            "Em Ä‘Ã£ uá»‘ng nÆ°á»›c chÆ°a? ğŸ’§",
            "CÃ¡i mÅ©i nÆ°á»›c máº¯t anh/chá»‹ chá»‰ vÃ¬ yÃªu em! ğŸ˜­ğŸ’•"
        ];
        
        let loveBotActive = false;
        let loveBotMinimized = false;
        let loveBotLastSendTime = {};
        const LOVEBOT_SEND_TIMES = [8, 12, 21]; // 8am, 12pm, 9pm

        function getRecentChatHistory() {
            try {
                const messages = JSON.parse(localStorage.getItem('loveBotMessages') || '[]');
                return messages.slice(-10).map((item) => ({
                    sender: item.sender,
                    message: item.message
                }));
            } catch (error) {
                return [];
            }
        }
        
        function toggleLoveBot() {
            const container = document.getElementById('lovebotContainer');
            if (!container) return;
            
            if (loveBotMinimized) {
                expandLoveBot();
            } else {
                minimizeLoveBot();
            }
        }
        
        function expandLoveBot() {
            const container = document.getElementById('lovebotContainer');
            if (!container) return;
            
            container.classList.remove('minimized');
            loveBotMinimized = false;
            loveBotActive = true;
            
            // Start bot if not already running
            if (!window.loveBotInterval) {
                startLoveBotScheduler();
            }
        }
        
        function minimizeLoveBot() {
            const container = document.getElementById('lovebotContainer');
            if (!container) return;
            
            container.classList.add('minimized');
            loveBotMinimized = true;
        }
        
        function openLoveBot() {
            expandLoveBot();
        }
        
        function closeLoveBot() {
            minimizeLoveBot();
        }
        
        function expandWhenMinimized(event) {
            const container = document.getElementById('lovebotContainer');
            if (container && loveBotMinimized) {
                event.stopPropagation();
                expandLoveBot();
            }
        }
        
        function addBotMessage(message) {
            const container = document.getElementById('lovebotContainer');
            if (!container) return;
            
            // Get or create messages area
            let messagesArea = container.querySelector('.lovebot-messages');
            if (!messagesArea) {
                messagesArea = document.createElement('div');
                messagesArea.className = 'lovebot-messages';
                container.appendChild(messagesArea);
            }
            
            // Create unique timestamp
            const timestamp = new Date().getTime();
            
            // Create and add message bubble
            const messageItem = document.createElement('div');
            messageItem.className = 'chat-bubble-item bot-msg';
            messageItem.setAttribute('data-timestamp', timestamp);
            messageItem.innerHTML = `
                <div class="chat-bubble bot-message">
                    <button class="chat-delete-btn" onclick="deleteMessage(${timestamp})" title="XÃ³a tin nháº¯n">âœ•</button>
                    <div class="chat-message-text">${message}</div>
                    <div class="chat-message-time">${new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `;
            
            messagesArea.appendChild(messageItem);
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Save to localStorage for persistence
            saveBotMessageToLocalStorage(message, 'bot', timestamp);
        }
        
        function saveBotMessageToLocalStorage(message, sender, timestamp) {
            const messages = JSON.parse(localStorage.getItem('loveBotMessages') || '[]');
            messages.push({
                time: timestamp || new Date().getTime(),
                message: message,
                sender: sender
            });
            // Keep only last 50 messages
            if (messages.length > 50) {
                messages.shift();
            }
            localStorage.setItem('loveBotMessages', JSON.stringify(messages));
        }
        
        function deleteMessage(timestamp) {
            // Find and remove message element from DOM with animation
            const messageItem = document.querySelector(`[data-timestamp="${timestamp}"]`);
            if (messageItem) {
                messageItem.classList.add('deleting');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    messageItem.remove();
                }, 300);
            }
            
            // Remove from localStorage
            const messages = JSON.parse(localStorage.getItem('loveBotMessages') || '[]');
            const filteredMessages = messages.filter(msg => msg.time !== timestamp);
            localStorage.setItem('loveBotMessages', JSON.stringify(filteredMessages));
        }
        
        function clearAllMessages() {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a táº¥t cáº£ tin nháº¯n? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.')) {
                return;
            }
            
            // Remove all messages from DOM with staggered animation
            const messageItems = document.querySelectorAll('.chat-bubble-item');
            messageItems.forEach((item, index) => {
                setTimeout(() => {
                    if (item) {
                        item.classList.add('deleting');
                        setTimeout(() => item.remove(), 300);
                    }
                }, index * 50); // Stagger the deletion for visual effect
            });
            
            // Clear localStorage
            localStorage.removeItem('loveBotMessages');
            
            // Show welcome message after all deleted
            setTimeout(() => {
                const container = document.getElementById('lovebotContainer');
                const messagesArea = container.querySelector('.lovebot-messages');
                
                if (messagesArea) {
                    const welcomeItem = document.createElement('div');
                    welcomeItem.className = 'chat-bubble-item bot-msg';
                    welcomeItem.innerHTML = `
                        <div class="chat-bubble bot-message">
                            <div class="chat-message-text">Hellu Bae! Nhá»› anh rá»“i háº£aaa</div>
                        </div>
                    `;
                    messagesArea.appendChild(welcomeItem);
                }
                
                showSuccess('ğŸ—‘ï¸ ÄÃ£ xÃ³a táº¥t cáº£ tin nháº¯n!');
            }, messageItems.length * 50 + 400);
            
            // Clear cache as well
            loveBotCache.clear();
        }
        
        function loadBotMessagesFromLocalStorage() {
            const messages = JSON.parse(localStorage.getItem('loveBotMessages') || '[]');
            const container = document.getElementById('lovebotContainer');
            
            // Clear existing messages
            const messagesArea = container.querySelector('.lovebot-messages');
            if (messagesArea) {
                const bubbles = messagesArea.querySelectorAll('.chat-bubble-item');
                bubbles.forEach(bubble => bubble.remove());
            }
            
            if (!container.querySelector('.lovebot-messages')) {
                const newMessagesArea = document.createElement('div');
                newMessagesArea.className = 'lovebot-messages';
                container.appendChild(newMessagesArea);
            }

            const targetArea = container.querySelector('.lovebot-messages');

            // If no saved messages, show initial greeting
            if (!messages.length) {
                const welcomeItem = document.createElement('div');
                welcomeItem.className = 'chat-bubble-item bot-msg';
                welcomeItem.innerHTML = `
                    <div class="chat-bubble bot-message">
                        <div class="chat-message-text">Hellu Bae! Nhá»› anh rá»“i háº£aaa</div>
                    </div>
                `;
                targetArea.appendChild(welcomeItem);
                return;
            }

            // Load saved messages (bot + user)
            messages.forEach(msg => {
                const messageItem = document.createElement('div');
                const msgDate = new Date(msg.time);
                const timeText = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                messageItem.setAttribute('data-timestamp', msg.time);

                if (msg.sender === 'bot') {
                    messageItem.className = 'chat-bubble-item bot-msg';
                    messageItem.innerHTML = `
                        <div class="chat-bubble bot-message">
                            <button class="chat-delete-btn" onclick="deleteMessage(${msg.time})" title="XÃ³a tin nháº¯n">âœ•</button>
                            <div class="chat-message-text">${msg.message}</div>
                            <div class="chat-message-time">${timeText}</div>
                        </div>
                    `;
                } else {
                    messageItem.className = 'chat-bubble-item user-msg';
                    messageItem.innerHTML = `
                        <div class="chat-bubble user-message">
                            <button class="chat-delete-btn" onclick="deleteMessage(${msg.time})" title="XÃ³a tin nháº¯n">âœ•</button>
                            <div class="chat-message-text">${msg.message}</div>
                            <div class="chat-message-time">${timeText}</div>
                        </div>
                    `;
                }

                targetArea.appendChild(messageItem);
            });
        }
        
        function startLoveBotScheduler() {
            // Check every minute if it's time to send message
            window.loveBotInterval = setInterval(() => {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const dateKey = `${now.toDateString()}_${currentHour}`;
                
                // Check if current hour matches one of the send times
                if (LOVEBOT_SEND_TIMES.includes(currentHour)) {
                    // Send message only once per hour
                    if (!loveBotLastSendTime[dateKey]) {
                        loveBotLastSendTime[dateKey] = true;
                        
                        // Randomly choose between love quote and greeting
                        let messageToSend;
                        if (Math.random() < 0.5) {
                            // Send a love quote
                            const randomQuoteIndex = Math.floor(Math.random() * loveQuotes.length);
                            messageToSend = loveQuotes[randomQuoteIndex];
                        } else {
                            // Send a greeting
                            const randomGreetingIndex = Math.floor(Math.random() * loveBotGreetings.length);
                            messageToSend = loveBotGreetings[randomGreetingIndex];
                        }
                        
                        // Show message immediately if container is visible
                        addBotMessage(messageToSend);
                        
                        // Show notification
                        if (loveBotActive) {
                            showSuccess('ğŸ’¬ Love Bot: ' + messageToSend);
                        }
                    }
                }
                
                // Clean up old entries from loveBotLastSendTime (keep only current day)
                const keys = Object.keys(loveBotLastSendTime);
                keys.forEach(key => {
                    if (!key.startsWith(now.toDateString())) {
                        delete loveBotLastSendTime[key];
                    }
                });
            }, 60000); // Check every minute
        }
        
        function stopLoveBotScheduler() {
            if (window.loveBotInterval) {
                clearInterval(window.loveBotInterval);
                window.loveBotInterval = null;
            }
        }
        
        // Helper function to normalize message for caching
        function normalizeCacheKey(message) {
            return message.toLowerCase().trim().replace(/[^\w\s]/g, '');
        }
        
        // Check and update rate limit
        function checkRateLimit() {
            const now = Date.now();
            
            // Reset counter if time window expired
            if (now > loveBotRateLimitResetTime) {
                loveBotRequestCount = 0;
                loveBotRateLimitResetTime = now + 60000;
            }
            
            // Check if exceeded rate limit
            if (loveBotRequestCount >= LOVEBOT_RATE_LIMIT) {
                const timeLeft = Math.ceil((loveBotRateLimitResetTime - now) / 1000);
                showError(`â±ï¸ Báº¡n gá»­i tin quÃ¡ nhanh! Vui lÃ²ng chá» ${timeLeft} giÃ¢y.`);
                return false;
            }
            
            loveBotRequestCount++;
            return true;
        }
        
        // Send user message to Love Bot
        async function sendUserMessage() {
            const input = document.getElementById('lovebotInput');
            const sendBtn = document.getElementById('lovebotSendBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Debouncing - prevent spam
            const currentTime = Date.now();
            if (currentTime - loveBotLastRequestTime < LOVEBOT_REQUEST_COOLDOWN) {
                return;
            }
            loveBotLastRequestTime = currentTime;
            
            // Rate limiting check
            if (!checkRateLimit()) {
                return;
            }
            
            // Create user message bubble
            const messagesArea = document.querySelector('.lovebot-messages');
            const messageItem = document.createElement('div');
            messageItem.className = 'chat-bubble-item user-msg';
            
            const now = new Date();
            const timestamp = now.getTime();
            const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            messageItem.setAttribute('data-timestamp', timestamp);
            messageItem.innerHTML = `
                <div class="chat-bubble user-message">
                    <button class="chat-delete-btn" onclick="deleteMessage(${timestamp})" title="XÃ³a tin nháº¯n">âœ•</button>
                    <div class="chat-message-text">${escapeHtml(message)}</div>
                    <div class="chat-message-time">${timeStr}</div>
                </div>
            `;
            
            messagesArea.appendChild(messageItem);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Save user message to localStorage for persistence
            saveBotMessageToLocalStorage(message, 'user', timestamp);
            
            // Clear input
            input.value = '';
            input.focus();
            
            if (sendBtn) sendBtn.disabled = true;
            input.disabled = true;

            try {
                // Show typing indicator
                showTypingIndicator();
                
                await getBotResponse(message);
            } finally {
                // Hide typing indicator
                hideTypingIndicator();
                
                if (sendBtn) sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }
        
        // Get bot response with retry logic and caching
        async function getBotResponse(userMessage, retryCount = 0) {
            // Check cache first
            const cacheKey = normalizeCacheKey(userMessage);
            const cachedResponse = loveBotCache.get(cacheKey);
            
            if (cachedResponse && (Date.now() - cachedResponse.timestamp < LOVEBOT_CACHE_TTL)) {
                addBotMessage(cachedResponse.reply);
                return;
            }
            
            try {
                // Cancel previous request if exists
                if (loveBotAbortController) {
                    loveBotAbortController.abort();
                }
                
                // Create new abort controller for timeout
                loveBotAbortController = new AbortController();
                const timeoutId = setTimeout(() => loveBotAbortController.abort(), LOVEBOT_REQUEST_TIMEOUT);
                
                const response = await fetch(LOVEBOT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        history: getRecentChatHistory()
                    }),
                    signal: loveBotAbortController.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Chat API error: ${response.status}`);
                }

                const data = await response.json();
                const botMessage = (data && data.reply) ? data.reply : '';

                if (!botMessage) {
                    throw new Error('Empty bot response');
                }

                // Cache the response
                loveBotCache.set(cacheKey, {
                    reply: botMessage,
                    timestamp: Date.now()
                });
                
                // Limit cache size
                if (loveBotCache.size > LOVEBOT_CACHE_SIZE) {
                    const firstKey = loveBotCache.keys().next().value;
                    loveBotCache.delete(firstKey);
                }

                addBotMessage(botMessage);
            } catch (error) {
                // Retry logic for network errors (not for aborts)
                if (error.name !== 'AbortError' && retryCount < LOVEBOT_MAX_RETRIES) {
                    // Exponential backoff: 1s, 2s
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return getBotResponse(userMessage, retryCount + 1);
                }
                
                // Show appropriate error message
                let errorMsg;
                if (error.name === 'AbortError') {
                    errorMsg = 'Xin lá»—i, server pháº£n há»“i quÃ¡ lÃ¢u. Thá»­ láº¡i nhÃ©! â±ï¸';
                } else if (retryCount >= LOVEBOT_MAX_RETRIES) {
                    errorMsg = 'Xin lá»—i, tÃ´i hÆ¡i báº­n rá»“i. Há»i láº¡i sau nhÃ©! ğŸ”„';
                } else {
                    errorMsg = Math.random() < 0.6
                        ? loveBotGreetings[Math.floor(Math.random() * loveBotGreetings.length)]
                        : loveQuotes[Math.floor(Math.random() * loveQuotes.length)];
                }
                
                addBotMessage(errorMsg);
            } finally {
                loveBotAbortController = null;
            }
        }
        
        function showTypingIndicator() {
            const messagesArea = document.querySelector('.lovebot-messages');
            if (!messagesArea) return;
            
            // Remove any existing typing indicator
            const existingTyping = messagesArea.querySelector('.typing-indicator-item');
            if (existingTyping) existingTyping.remove();
            
            // Create typing indicator bubble
            const typingItem = document.createElement('div');
            typingItem.className = 'chat-bubble-item bot-msg typing-indicator-item';
            typingItem.innerHTML = `
                <div class="chat-bubble bot-message typing-indicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(typingItem);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const messagesArea = document.querySelector('.lovebot-messages');
            if (!messagesArea) return;
            
            const typingItem = messagesArea.querySelector('.typing-indicator-item');
            if (typingItem) {
                // Smooth fade out and remove
                typingItem.style.opacity = '0';
                typingItem.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (typingItem.parentNode) {
                        typingItem.remove();
                    }
                }, 300);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function setupBotInputHandlers() {
            const input = document.getElementById('lovebotInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendUserMessage();
                    }
                });
            }
        }
        
        // Initialize Love Bot on page load
        function initLoveBot() {
            // Load saved messages
            loadBotMessagesFromLocalStorage();
            
            // Setup input handlers
            setupBotInputHandlers();
            
            // Start bot scheduler
            const container = document.getElementById('lovebotContainer');
            if (container) {
                if (!window.loveBotInterval) {
                    startLoveBotScheduler();
                }
                loveBotActive = true;
                
                // Minimize by default
                loveBotMinimized = true;
                container.classList.add('minimized');
            }
            
            // Mark as initialized
            if (!localStorage.getItem('loveBotInitialized')) {
                localStorage.setItem('loveBotInitialized', 'true');
            }
        }
        

    </script>
</body>
</html>
