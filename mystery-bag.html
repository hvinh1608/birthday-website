<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BÃ³c TÃºi MÃ¹ Tiá»n Máº·t</title>
    <link rel="stylesheet" href="./style.css?v=5.0">
</head>
<body class="mystery-body">
    <!-- Audio element cho nháº¡c ná»n -->
    <audio id="mysteryMusic" loop autoplay preload="auto">
        <source src="./music/mystery-music.mp3" type="audio/mpeg">
        <source src="./music/mystery-music.wav" type="audio/wav">
        <source src="./music/mystery-music.ogg" type="audio/ogg">
        <!-- Fallback online music náº¿u khÃ´ng cÃ³ file local -->
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <!-- NÃºt Ä‘iá»u khiá»ƒn nháº¡c -->
    <button id="musicControl" class="mystery-music-control" onclick="toggleMusic()">ğŸµ Báº­t nháº¡c</button>
    
    <div class="mystery-container">
        <h1 class="mystery-title">ğŸ‚ Thá»•i Náº¿n Sinh Nháº­t</h1>
        <p class="mystery-subtitle">Nháº¥p vÃ o bÃ¡nh sinh nháº­t Ä‘á»ƒ thá»•i náº¿n vÃ  nháº­n quÃ !</p>
        
        <div class="birthday-cake" id="birthdayCake" onclick="blowCandles()">
            <div class="cake-base">
                <div class="cake-layer layer-3"></div>
                <div class="cake-layer layer-2"></div>
                <div class="cake-layer layer-1"></div>
                <div class="cake-decoration">
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">ğŸ”¥</div>
                    </div>
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">ğŸ”¥</div>
                    </div>
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">ğŸ”¥</div>
                    </div>
                    <div class="cake-text">ğŸ‰ HAPPY BIRTHDAY ğŸ‰</div>
                </div>
            </div>
        </div>
        
        <div class="mystery-result" id="result"></div>
        
        <div class="mystery-buttons">
            <button class="mystery-btn mystery-btn-primary" onclick="blowCandles()">ğŸ‚ Thá»•i náº¿n má»›i</button>
            <button class="mystery-btn mystery-btn-secondary" onclick="resetStats()">ğŸ”„ Reset thá»‘ng kÃª</button>
            <a href="index.html" class="mystery-btn mystery-btn-back">ğŸ  Vá» trang chá»§</a>
        </div>
        
        <div class="mystery-stats" id="stats">
            <h3>ğŸ“Š Thá»‘ng kÃª cá»§a báº¡n</h3>
            <div class="mystery-stat-item">
                <span>Sá»‘ láº§n bÃ³c:</span>
                <span id="totalOpens">0</span>
            </div>
            <div class="mystery-stat-item">
                <span>Láº§n trÃºng lá»›n nháº¥t:</span>
                <span id="biggestWin">0 VNÄ</span>
            </div>
            <div class="mystery-stat-item">
                <span>Láº§n trÃºng nhá» nháº¥t:</span>
                <span id="smallestWin">0 VNÄ</span>
            </div>
            <div class="mystery-stat-item mystery-total-earned">
                <span>Tá»•ng tiá»n Ä‘Ã£ nháº­n:</span>
                <span id="totalEarned">0 VNÄ</span>
            </div>
        </div>
    </div>

    <canvas class="mystery-fireworks" id="fireworks"></canvas>

    <script>
        // Äá»‹nh nghÄ©a cÃ¡c má»‡nh giÃ¡ tiá»n Viá»‡t Nam (tá»« 10k Ä‘áº¿n 500k) vá»›i trá»ng sá»‘
        const moneyValues = [
            { value: 500000, type: 'note', name: '500.000 VNÄ', class: 'note-500k', emoji: 'ğŸ’°', weight: 1 },  // Ráº¥t hiáº¿m (1%)
            { value: 200000, type: 'note', name: '200.000 VNÄ', class: 'note-200k', emoji: 'ğŸ’µ', weight: 3 },  // Hiáº¿m (3%)
            { value: 100000, type: 'note', name: '100.000 VNÄ', class: 'note-100k', emoji: 'ğŸ’¸', weight: 8 },  // KhÃ¡ hiáº¿m (8%)
            { value: 50000, type: 'note', name: '50.000 VNÄ', class: 'note-50k', emoji: 'ğŸ’´', weight: 18 },    // BÃ¬nh thÆ°á»ng (18%)
            { value: 20000, type: 'note', name: '20.000 VNÄ', class: 'note-20k', emoji: 'ğŸ’¶', weight: 30 },    // ThÆ°á»ng gáº·p (30%)
            { value: 10000, type: 'note', name: '10.000 VNÄ', class: 'note-10k', emoji: 'ğŸ’·', weight: 40 }     // Ráº¥t thÆ°á»ng (40%)
        ];

        // Táº¡o máº£ng weighted cho random
        let weightedArray = [];
        moneyValues.forEach(money => {
            for (let i = 0; i < money.weight; i++) {
                weightedArray.push(money);
            }
        });

        // Thá»‘ng kÃª
        let stats = {
            totalOpens: 0,
            totalEarned: 0,
            biggestWin: 0,
            smallestWin: Infinity,
            history: []
        };

        // Load stats tá»« localStorage
        function loadStats() {
            const savedStats = localStorage.getItem('mysteryBagStats');
            if (savedStats) {
                stats = JSON.parse(savedStats);
                updateStatsDisplay();
            }
        }

        // Save stats vÃ o localStorage
        function saveStats() {
            localStorage.setItem('mysteryBagStats', JSON.stringify(stats));
        }

        // Cáº­p nháº­t hiá»ƒn thá»‹ thá»‘ng kÃª
        function updateStatsDisplay() {
            document.getElementById('totalOpens').textContent = stats.totalOpens;
            document.getElementById('totalEarned').textContent = formatMoney(stats.totalEarned);
            document.getElementById('biggestWin').textContent = formatMoney(stats.biggestWin);
            document.getElementById('smallestWin').textContent = stats.smallestWin === Infinity ? '0 VNÄ' : formatMoney(stats.smallestWin);
        }

        // Format tiá»n tá»‡
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNÄ';
        }

        // Táº¡o phÃ¡o hoa
        function createFireworks() {
            const canvas = document.getElementById('fireworks');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const colors = ['#ff9a9e', '#fecfef', '#fda085', '#ffd700', '#ff6b9d', '#ffc1cc'];

            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 5 + 2,
                    life: 1,
                    decay: Math.random() * 0.02 + 0.01
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles.forEach((particle, index) => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life -= particle.decay;
                    particle.size *= 0.98;

                    ctx.globalAlpha = particle.life;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();

                    if (particle.life <= 0) {
                        particles.splice(index, 1);
                    }
                });

                if (particles.length > 0) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        // HÃ m chÃ­nh - thá»•i náº¿n
        function blowCandles() {
            const cake = document.getElementById('birthdayCake');
            const result = document.getElementById('result');
            const candles = cake.querySelectorAll('.candle');
            
            // Animation thá»•i náº¿n
            cake.classList.add('blowing');
            
            // Táº¯t tá»«ng ngá»n náº¿n vá»›i hiá»‡u á»©ng
            candles.forEach((candle, index) => {
                setTimeout(() => {
                    candle.setAttribute('data-lit', 'false');
                    const flame = candle.querySelector('.flame');
                    
                    // ThÃªm khÃ³i
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke';
                    smoke.innerHTML = 'ğŸ’¨';
                    candle.appendChild(smoke);
                    
                    // XÃ³a khÃ³i sau 2 giÃ¢y
                    setTimeout(() => {
                        smoke.remove();
                    }, 2000);
                }, index * 200);
            });
            
            setTimeout(() => {
                // Chá»n ngáº«u nhiÃªn má»™t má»‡nh giÃ¡ dá»±a trÃªn trá»ng sá»‘
                const randomMoney = weightedArray[Math.floor(Math.random() * weightedArray.length)];
                
                // Hiá»ƒn thá»‹ káº¿t quáº£
                showResult(randomMoney);
                
                // Cáº­p nháº­t thá»‘ng kÃª
                updateStats(randomMoney.value);
                
                // Reset bÃ¡nh sinh nháº­t
                setTimeout(() => {
                    cake.classList.remove('blowing');
                    candles.forEach(candle => {
                        candle.setAttribute('data-lit', 'true');
                        // XÃ³a khÃ³i náº¿u cÃ²n
                        const existingSmoke = candle.querySelector('.smoke');
                        if (existingSmoke) {
                            existingSmoke.remove();
                        }
                    });
                }, 1500);
                
                // PhÃ¡o hoa cho giáº£i lá»›n
                if (randomMoney.value >= 100000) {
                    createFireworks();
                }
            }, 800);
        }

        // Hiá»ƒn thá»‹ káº¿t quáº£
        function showResult(money) {
            const result = document.getElementById('result');
            
            let html = `
                <div class="money-amount">${money.emoji} ${formatMoney(money.value)}</div>
                <div class="money-note">Báº¡n Ä‘Ã£ nháº­n Ä‘Æ°á»£c ${money.name}!</div>
                <div class="money-visual ${money.class}">${money.name}</div>
            `;
            
            // ThÃªm thÃ´ng bÃ¡o Ä‘áº·c biá»‡t
            if (money.value >= 500000) {
                html += '<div style="color: #e53e3e; font-size: 1.5em; margin-top: 10px;">ğŸ‰ JACKPOT! Báº¡n Ä‘Ã£ trÃºng giáº£i lá»›n! ğŸ‰</div>';
            } else if (money.value >= 100000) {
                html += '<div style="color: #38a169; font-size: 1.2em; margin-top: 10px;">ğŸŒŸ Giáº£i khÃ¡! ChÃºc má»«ng! ğŸŒŸ</div>';
            } else if (money.value <= 20000) {
                html += '<div style="color: #718096; font-size: 1em; margin-top: 10px;">ğŸ’ª Cá»‘ gáº¯ng láº§n sau nhÃ©!</div>';
            }
            
            result.innerHTML = html;
        }

        // Cáº­p nháº­t thá»‘ng kÃª
        function updateStats(amount) {
            stats.totalOpens++;
            stats.totalEarned += amount;
            stats.biggestWin = Math.max(stats.biggestWin, amount);
            stats.smallestWin = Math.min(stats.smallestWin, amount);
            stats.history.push({
                amount: amount,
                timestamp: new Date().toISOString()
            });
            
            // Giá»¯ láº¡i tá»‘i Ä‘a 100 lá»‹ch sá»­
            if (stats.history.length > 100) {
                stats.history = stats.history.slice(-100);
            }
            
            updateStatsDisplay();
            saveStats();
        }

        // Reset thá»‘ng kÃª
        function resetStats() {
            if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a táº¥t cáº£ thá»‘ng kÃª?')) {
                stats = {
                    totalOpens: 0,
                    totalEarned: 0,
                    biggestWin: 0,
                    smallestWin: Infinity,
                    history: []
                };
                updateStatsDisplay();
                saveStats();
                
                document.getElementById('result').innerHTML = '<div style="color: #38a169; font-size: 1.2em;">âœ… ÄÃ£ reset thá»‘ng kÃª!</div>';
            }
        }

        // Khá»Ÿi táº¡o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // ThÃªm hiá»‡u á»©ng nháº¥p nhÃ¡y cho bÃ¡nh sinh nháº­t
            setInterval(() => {
                const cake = document.getElementById('birthdayCake');
                if (!cake.classList.contains('blowing')) {
                    cake.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        cake.style.transform = 'scale(1)';
                    }, 300);
                }
            }, 5000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                blowCandles();
            }
        });

        // Music control functions
        function toggleMusic() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (music.paused) {
                music.volume = 0.3; // Ã‚m lÆ°á»£ng 30%
                music.play().then(() => {
                    musicControl.textContent = 'ğŸ”‡ Táº¯t nháº¡c';
                }).catch(error => {
                    console.log('Could not play music:', error);
                    musicControl.textContent = 'ğŸµ KhÃ´ng cÃ³ nháº¡c';
                });
            } else {
                music.pause();
                musicControl.textContent = 'ğŸµ Báº­t nháº¡c';
            }
        }

        // Auto play music functions
        function tryAutoPlayMusic() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            music.volume = 0.3;
            music.play().then(() => {
                console.log('Music auto-played successfully');
                musicControl.textContent = 'ğŸ”‡ Táº¯t nháº¡c';
            }).catch(error => {
                console.log('Auto-play blocked, waiting for user interaction:', error);
                musicControl.textContent = 'ğŸµ Báº­t nháº¡c';
            });
        }

        // Try to auto-play when page loads
        window.addEventListener('load', function() {
            setTimeout(tryAutoPlayMusic, 500); // Delay 0.5s Ä‘á»ƒ trang load xong
        });

        // Auto start music on first user interaction (desktop & mobile)
        const startMusicEvents = ['click', 'touchstart', 'touchend', 'keydown', 'scroll'];
        
        function enableMusicOnInteraction() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (music.paused) {
                music.volume = 0.3;
                music.play().then(() => {
                    musicControl.textContent = 'ğŸ”‡ Táº¯t nháº¡c';
                    console.log('Music started on user interaction');
                }).catch(error => {
                    console.log('Could not start music on interaction:', error);
                });
            }
            
            // Remove event listeners after first interaction
            startMusicEvents.forEach(event => {
                document.removeEventListener(event, enableMusicOnInteraction);
            });
        }

        // Add event listeners for auto-play on interaction
        startMusicEvents.forEach(event => {
            document.addEventListener(event, enableMusicOnInteraction, { once: true });
        });
    </script>
</body>
</html>
