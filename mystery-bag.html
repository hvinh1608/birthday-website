<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≥c T√∫i M√π Ti·ªÅn M·∫∑t</title>
    <link rel="stylesheet" href="./style.css?v=5.0">
</head>
<body class="mystery-body">
    <!-- Audio element cho nh·∫°c n·ªÅn -->
    <audio id="mysteryMusic" loop autoplay preload="auto">
        <source src="./music/mystery-music.mp3" type="audio/mpeg">
        <source src="./music/mystery-music.wav" type="audio/wav">
        <source src="./music/mystery-music.ogg" type="audio/ogg">
        <!-- Fallback online music n·∫øu kh√¥ng c√≥ file local -->
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <!-- N√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c -->
    <button id="musicControl" class="mystery-music-control" onclick="toggleMusic()">üéµ B·∫≠t nh·∫°c</button>
    
    <div class="mystery-container">
        <h1 class="mystery-title">üéÇ Th·ªïi N·∫øn Sinh Nh·∫≠t</h1>
        <p class="mystery-subtitle">Nh·∫•p v√†o b√°nh sinh nh·∫≠t ƒë·ªÉ th·ªïi n·∫øn v√† nh·∫≠n qu√†!</p>
        
        <div class="birthday-cake" id="birthdayCake" onclick="blowCandles()">
            <div class="cake-base">
                <div class="cake-layer layer-3"></div>
                <div class="cake-layer layer-2"></div>
                <div class="cake-layer layer-1"></div>
                <div class="cake-decoration">
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">üî•</div>
                    </div>
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">üî•</div>
                    </div>
                    <div class="candle" data-lit="true">
                        <div class="candle-stick"></div>
                        <div class="flame">üî•</div>
                    </div>
                    <div class="cake-text">üéâ HAPPY BIRTHDAY üéâ</div>
                </div>
            </div>
        </div>
        
        <div class="mystery-result" id="result"></div>
        
        <div class="mystery-buttons">
            <button class="mystery-btn mystery-btn-primary" onclick="blowCandles()">üéÇ Th·ªïi n·∫øn m·ªõi</button>
            <button class="mystery-btn mystery-btn-secondary" onclick="resetStats()">üîÑ Reset th·ªëng k√™</button>
            <a href="index.html" class="mystery-btn mystery-btn-back">üè† V·ªÅ trang ch·ªß</a>
        </div>
        
        <div class="mystery-stats" id="stats">
            <h3>üìä Th·ªëng k√™ c·ªßa b·∫°n</h3>
            <div class="mystery-stat-item">
                <span>S·ªë l·∫ßn b√≥c:</span>
                <span id="totalOpens">0</span>
            </div>
            <div class="mystery-stat-item">
                <span>L·∫ßn tr√∫ng l·ªõn nh·∫•t:</span>
                <span id="biggestWin">0 VNƒê</span>
            </div>
            <div class="mystery-stat-item">
                <span>L·∫ßn tr√∫ng nh·ªè nh·∫•t:</span>
                <span id="smallestWin">0 VNƒê</span>
            </div>
            <div class="mystery-stat-item mystery-total-earned">
                <span>T·ªïng ti·ªÅn ƒë√£ nh·∫≠n:</span>
                <span id="totalEarned">0 VNƒê</span>
            </div>
        </div>
    </div>

    <canvas class="mystery-fireworks" id="fireworks"></canvas>

    <script>
        // ƒê·ªãnh nghƒ©a c√°c m·ªánh gi√° ti·ªÅn Vi·ªát Nam (t·ª´ 10k ƒë·∫øn 500k) v·ªõi tr·ªçng s·ªë
        const moneyValues = [
            { value: 500000, type: 'note', name: '500.000 VNƒê', class: 'note-500k', emoji: 'üí∞', weight: 1 },  // R·∫•t hi·∫øm (1%)
            { value: 200000, type: 'note', name: '200.000 VNƒê', class: 'note-200k', emoji: 'üíµ', weight: 3 },  // Hi·∫øm (3%)
            { value: 100000, type: 'note', name: '100.000 VNƒê', class: 'note-100k', emoji: 'üí∏', weight: 8 },  // Kh√° hi·∫øm (8%)
            { value: 50000, type: 'note', name: '50.000 VNƒê', class: 'note-50k', emoji: 'üí¥', weight: 18 },    // B√¨nh th∆∞·ªùng (18%)
            { value: 20000, type: 'note', name: '20.000 VNƒê', class: 'note-20k', emoji: 'üí∂', weight: 30 },    // Th∆∞·ªùng g·∫∑p (30%)
            { value: 10000, type: 'note', name: '10.000 VNƒê', class: 'note-10k', emoji: 'üí∑', weight: 40 }     // R·∫•t th∆∞·ªùng (40%)
        ];

        // T·∫°o m·∫£ng weighted cho random
        let weightedArray = [];
        moneyValues.forEach(money => {
            for (let i = 0; i < money.weight; i++) {
                weightedArray.push(money);
            }
        });

        // Th·ªëng k√™
        let stats = {
            totalOpens: 0,
            totalEarned: 0,
            biggestWin: 0,
            smallestWin: Infinity,
            history: []
        };

        // Load stats t·ª´ localStorage
        function loadStats() {
            const savedStats = localStorage.getItem('mysteryBagStats');
            if (savedStats) {
                stats = JSON.parse(savedStats);
                updateStatsDisplay();
            }
        }

        // Save stats v√†o localStorage
        function saveStats() {
            localStorage.setItem('mysteryBagStats', JSON.stringify(stats));
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªëng k√™
        function updateStatsDisplay() {
            document.getElementById('totalOpens').textContent = stats.totalOpens;
            document.getElementById('totalEarned').textContent = formatMoney(stats.totalEarned);
            document.getElementById('biggestWin').textContent = formatMoney(stats.biggestWin);
            document.getElementById('smallestWin').textContent = stats.smallestWin === Infinity ? '0 VNƒê' : formatMoney(stats.smallestWin);
        }

        // Format ti·ªÅn t·ªá
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        // T·∫°o ph√°o hoa
        function createFireworks() {
            const canvas = document.getElementById('fireworks');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const colors = ['#ff9a9e', '#fecfef', '#fda085', '#ffd700', '#ff6b9d', '#ffc1cc'];

            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 5 + 2,
                    life: 1,
                    decay: Math.random() * 0.02 + 0.01
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles.forEach((particle, index) => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life -= particle.decay;
                    particle.size *= 0.98;

                    ctx.globalAlpha = particle.life;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();

                    if (particle.life <= 0) {
                        particles.splice(index, 1);
                    }
                });

                if (particles.length > 0) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        // H√†m ch√≠nh - th·ªïi n·∫øn
        function blowCandles() {
            const cake = document.getElementById('birthdayCake');
            const result = document.getElementById('result');
            const candles = cake.querySelectorAll('.candle');
            
            // Animation th·ªïi n·∫øn
            cake.classList.add('blowing');
            
            // T·∫Øt t·ª´ng ng·ªçn n·∫øn v·ªõi hi·ªáu ·ª©ng
            candles.forEach((candle, index) => {
                setTimeout(() => {
                    candle.setAttribute('data-lit', 'false');
                    const flame = candle.querySelector('.flame');
                    
                    // Th√™m kh√≥i
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke';
                    smoke.innerHTML = 'üí®';
                    candle.appendChild(smoke);
                    
                    // X√≥a kh√≥i sau 2 gi√¢y
                    setTimeout(() => {
                        smoke.remove();
                    }, 2000);
                }, index * 200);
            });
            
            setTimeout(() => {
                // Ch·ªçn ng·∫´u nhi√™n m·ªôt m·ªánh gi√° d·ª±a tr√™n tr·ªçng s·ªë
                const randomMoney = weightedArray[Math.floor(Math.random() * weightedArray.length)];
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                showResult(randomMoney);
                
                // C·∫≠p nh·∫≠t th·ªëng k√™
                updateStats(randomMoney.value);
                
                // Reset b√°nh sinh nh·∫≠t
                setTimeout(() => {
                    cake.classList.remove('blowing');
                    candles.forEach(candle => {
                        candle.setAttribute('data-lit', 'true');
                        // X√≥a kh√≥i n·∫øu c√≤n
                        const existingSmoke = candle.querySelector('.smoke');
                        if (existingSmoke) {
                            existingSmoke.remove();
                        }
                    });
                }, 1500);
                
                // Ph√°o hoa cho gi·∫£i l·ªõn
                if (randomMoney.value >= 100000) {
                    createFireworks();
                }
            }, 800);
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        function showResult(money) {
            const result = document.getElementById('result');
            
            let html = `
                <div class="money-amount">${money.emoji} ${formatMoney(money.value)}</div>
                <div class="money-note">B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ${money.name}!</div>
                <div class="money-visual ${money.class}">${money.name}</div>
            `;
            
            // Th√™m th√¥ng b√°o ƒë·∫∑c bi·ªát
            if (money.value >= 500000) {
                html += '<div style="color: #e53e3e; font-size: 1.5em; margin-top: 10px;">üéâ JACKPOT! B·∫°n ƒë√£ tr√∫ng gi·∫£i l·ªõn! üéâ</div>';
            } else if (money.value >= 100000) {
                html += '<div style="color: #38a169; font-size: 1.2em; margin-top: 10px;">üåü Gi·∫£i kh√°! Ch√∫c m·ª´ng! üåü</div>';
            } else if (money.value <= 20000) {
                html += '<div style="color: #718096; font-size: 1em; margin-top: 10px;">üí™ C·ªë g·∫Øng l·∫ßn sau nh√©!</div>';
            }
            
            result.innerHTML = html;
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats(amount) {
            stats.totalOpens++;
            stats.totalEarned += amount;
            stats.biggestWin = Math.max(stats.biggestWin, amount);
            stats.smallestWin = Math.min(stats.smallestWin, amount);
            stats.history.push({
                amount: amount,
                timestamp: new Date().toISOString()
            });
            
            // Gi·ªØ l·∫°i t·ªëi ƒëa 100 l·ªãch s·ª≠
            if (stats.history.length > 100) {
                stats.history = stats.history.slice(-100);
            }
            
            updateStatsDisplay();
            saveStats();
        }

        // Reset th·ªëng k√™
        function resetStats() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ th·ªëng k√™?')) {
                stats = {
                    totalOpens: 0,
                    totalEarned: 0,
                    biggestWin: 0,
                    smallestWin: Infinity,
                    history: []
                };
                updateStatsDisplay();
                saveStats();
                
                document.getElementById('result').innerHTML = '<div style="color: #38a169; font-size: 1.2em;">‚úÖ ƒê√£ reset th·ªëng k√™!</div>';
            }
        }

        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // Th√™m hi·ªáu ·ª©ng nh·∫•p nh√°y cho b√°nh sinh nh·∫≠t
            setInterval(() => {
                const cake = document.getElementById('birthdayCake');
                if (!cake.classList.contains('blowing')) {
                    cake.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        cake.style.transform = 'scale(1)';
                    }, 300);
                }
            }, 5000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                blowCandles();
            }
        });

        // Music control functions
        function toggleMusic() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (music.paused) {
                music.volume = 0.3; // √Çm l∆∞·ª£ng 30%
                music.play().then(() => {
                    musicControl.textContent = 'üîá T·∫Øt nh·∫°c';
                }).catch(error => {
                    console.log('Could not play music:', error);
                    musicControl.textContent = 'üéµ Kh√¥ng c√≥ nh·∫°c';
                });
            } else {
                music.pause();
                musicControl.textContent = 'üéµ B·∫≠t nh·∫°c';
            }
        }

        // Auto play music functions
        function tryAutoPlayMusic() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            music.volume = 0.3;
            music.play().then(() => {
                console.log('Music auto-played successfully');
                musicControl.textContent = 'üîá T·∫Øt nh·∫°c';
            }).catch(error => {
                console.log('Auto-play blocked, waiting for user interaction:', error);
                musicControl.textContent = 'üéµ B·∫≠t nh·∫°c';
            });
        }

        // Try to auto-play when page loads
        window.addEventListener('load', function() {
            setTimeout(tryAutoPlayMusic, 500); // Delay 0.5s ƒë·ªÉ trang load xong
        });

        // Auto start music on first user interaction (desktop & mobile)
        const startMusicEvents = ['click', 'touchstart', 'touchend', 'keydown', 'scroll'];
        
        function enableMusicOnInteraction() {
            const music = document.getElementById('mysteryMusic');
            const musicControl = document.getElementById('musicControl');
            
            if (music.paused) {
                music.volume = 0.3;
                music.play().then(() => {
                    musicControl.textContent = 'üîá T·∫Øt nh·∫°c';
                    console.log('Music started on user interaction');
                }).catch(error => {
                    console.log('Could not start music on interaction:', error);
                });
            }
            
            // Remove event listeners after first interaction
            startMusicEvents.forEach(event => {
                document.removeEventListener(event, enableMusicOnInteraction);
            });
        }

        // Add event listeners for auto-play on interaction
        startMusicEvents.forEach(event => {
            document.addEventListener(event, enableMusicOnInteraction, { once: true });
        });
    </script>
</body>
</html>
